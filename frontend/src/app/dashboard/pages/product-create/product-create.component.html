<!-- Mobile-First Item Creation (Products & Services) -->

<!-- Header with Type Toggle -->
<div class="sticky top-0 z-30 bg-base-100/95 backdrop-blur-sm border-b">
  <div class="container-app py-2">
    <div class="flex items-center justify-between gap-2">
      <h1 class="text-lg font-bold">{{ itemType() === 'product' ? 'üì¶' : '‚ú®' }} Add Item</h1>
      <button type="button" (click)="cancel()" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
    </div>
    
    <!-- Product/Service Toggle -->
    <div class="tabs tabs-box mt-2">
      <button 
        type="button"
        class="tab"
        [class.tab-active]="itemType() === 'product'"
        (click)="toggleItemType('product')"
      >
        üì¶ Product
      </button>
      <button 
        type="button"
        class="tab"
        [class.tab-active]="itemType() === 'service'"
        (click)="toggleItemType('service')"
      >
        ‚ú® Service
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-app py-3 pb-32 max-w-lg mx-auto">
  <!-- Alerts -->
  @if (submitSuccess()) {
  <div role="alert" class="alert alert-success mb-3">
    <span>‚úì Created!</span>
  </div>
  }
  
  @if (submitError()) {
  <div role="alert" class="alert alert-error mb-3">
    <span>{{ submitError() }}</span>
  </div>
  }

  <!-- Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="space-y-3">
    
    <!-- Step 1: Product Name -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-2">1Ô∏è‚É£ Product Name</h3>
        <input
          type="text"
          formControlName="name"
          [placeholder]="itemType() === 'product' ? 'e.g., Tomatoes' : 'e.g., Haircut'"
          class="input input-bordered w-full"
          [class.input-error]="productForm.get('name')?.invalid && productForm.get('name')?.touched"
        />
      </div>
    </div>

    <!-- Step 2: Identification -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-2">
          {{ itemType() === 'product' ? '2Ô∏è‚É£ How to ID This Item?' : '2Ô∏è‚É£ How to ID This Service?' }}
        </h3>
        
        <div class="grid gap-2">
          <!-- Option A: Barcode -->
          <div 
            class="p-2 rounded border-2"
            [class.border-primary]="identificationMethod() === 'barcode'"
            [class.bg-primary/5]="identificationMethod() === 'barcode'"
            [class.border-base-300]="identificationMethod() !== 'barcode'"
          >
            <div 
              class="flex items-center gap-2 cursor-pointer"
              (click)="chooseIdentificationMethod('barcode')"
            >
              <div class="text-xl">üè∑Ô∏è</div>
              <div class="flex-1">
                <span class="font-semibold text-sm">Barcode</span>
                @if (productForm.get('barcode')?.value?.trim()) {
                <span class="text-xs opacity-70 ml-1">({{ productForm.get('barcode')?.value }})</span>
                }
              </div>
              @if (identificationMethod() === 'barcode' && productForm.get('barcode')?.value?.trim()) {
              <div class="text-primary">‚úì</div>
              }
            </div>
            
            @if (identificationMethod() === 'barcode') {
            <div class="flex gap-2 mt-2" (click)="$event.stopPropagation()">
              <input
                type="text"
                formControlName="barcode"
                placeholder="Type barcode here..."
                class="input input-sm input-bordered flex-1 font-mono"
                [class.input-success]="productForm.get('barcode')?.value?.trim()"
                autofocus
              />
              <button
                type="button"
                (click)="startBarcodeScanner()"
                class="btn btn-sm btn-primary"
                title="Scan with camera"
              >
                üì∑
              </button>
            </div>
            <p class="text-xs opacity-60 mt-1">Type the barcode or scan with camera</p>
            }
          </div>

          <!-- Option B: Photos -->
          <div 
            class="p-2 rounded border-2 cursor-pointer"
            [class.border-primary]="identificationMethod() === 'label-photos'"
            [class.bg-primary/5]="identificationMethod() === 'label-photos'"
            [class.border-base-300]="identificationMethod() !== 'label-photos'"
            (click)="chooseIdentificationMethod('label-photos')"
          >
            <div class="flex items-center gap-2 mb-2">
              <div class="text-xl">üì∏</div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-sm">
                    {{ itemType() === 'product' ? 'Tag Photos' : 'Card Photos' }}
                  </span>
                  @if (photoCount() > 0) {
                  <span class="badge badge-xs badge-primary">{{ photoCount() }}/5</span>
                  }
                </div>
              </div>
              @if (identificationMethod() === 'label-photos' && photoCount() >= 5) {
              <div class="text-primary">‚úì</div>
              }
            </div>

            @if (identificationMethod() === 'label-photos') {
            <!-- Inline help based on type -->
            @if (itemType() === 'product') {
            <div class="bg-warning/10 p-2 rounded text-xs mb-2">
              <strong>Photo the TAG, not the item!</strong>
              <p class="opacity-80 mt-1">Example: "TOMATO 10/=" written on cardboard</p>
            </div>
            } @else {
            <div class="bg-info/10 p-2 rounded text-xs mb-2">
              <strong>Photo the SERVICE CARD!</strong>
              <p class="opacity-80 mt-1">Example: "Haircut" card with ‚úÇÔ∏è icon on desk</p>
            </div>
            }

            <div>
              <app-photo-manager 
                #photoManager
                (photoCountChange)="onPhotosChanged($event)"
              />
              @if (photoCount() > 0 && photoCount() < 5) {
              <div class="text-xs text-warning mt-1">Need {{ 5 - photoCount() }} more</div>
              }
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: SKUs (Multiple) -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold text-sm">3Ô∏è‚É£ SKUs (Sizes/Tiers)</h3>
          <button
            type="button"
            (click)="addSku()"
            class="btn btn-xs btn-primary"
          >
            + Add SKU
          </button>
        </div>
        
        <p class="text-xs opacity-60 mb-3">
          {{ itemType() === 'product' ? 'e.g., 1kg, 2kg, 5kg' : 'e.g., Kids, Regular, Premium' }}. SKU IDs are auto-generated.
        </p>

        <!-- SKU List -->
        <div formArrayName="skus" class="space-y-3">
          @for (sku of skus.controls; track $index) {
          <div [formGroupName]="$index" class="p-3 bg-base-200 rounded">
            <div class="flex items-start justify-between gap-2 mb-2">
              <span class="text-xs font-semibold opacity-70">SKU #{{ $index + 1 }}</span>
              @if (skus.length > 1) {
              <button
                type="button"
                (click)="removeSku($index)"
                class="btn btn-xs btn-ghost btn-circle text-error"
              >
                ‚úï
              </button>
              }
            </div>

            <div class="space-y-2">
              <!-- SKU Name -->
              <div>
                <label class="text-xs opacity-70 mb-1 block">Name</label>
                <input
                  type="text"
                  formControlName="name"
                  placeholder="e.g., 1kg or Kids"
                  class="input input-sm input-bordered w-full"
                  [class.input-error]="skuFieldHasError($index, 'name')"
                />
                @if (skuFieldHasError($index, 'name')) {
                <p class="text-error text-xs mt-0.5">{{ getSkuFieldError($index, 'name') }}</p>
                }
              </div>

              <!-- SKU Code (Read-only preview) -->
              <div>
                <label class="text-xs opacity-70 mb-1 block">SKU ID (auto-generated)</label>
                <div class="px-3 py-2 bg-base-300 rounded text-xs font-mono opacity-70">
                  {{ sku.get('sku')?.value || 'AUTO' }}
                </div>
                <!-- Hidden field for form validation -->
                <input type="hidden" formControlName="sku" />
              </div>

              <!-- Price & Stock -->
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs opacity-70 mb-1 block">Price</label>
                  <input
                    type="number"
                    formControlName="price"
                    placeholder="0.00"
                    step="0.01"
                    min="0.01"
                    class="input input-sm input-bordered w-full"
                    [class.input-error]="skuFieldHasError($index, 'price')"
                  />
                  @if (skuFieldHasError($index, 'price')) {
                  <p class="text-error text-xs mt-0.5">{{ getSkuFieldError($index, 'price') }}</p>
                  }
                </div>

                @if (itemType() === 'product') {
                <div>
                  <label class="text-xs opacity-70 mb-1 block">Stock</label>
                  <input
                    type="number"
                    formControlName="stockOnHand"
                    placeholder="0"
                    min="0"
                    class="input input-sm input-bordered w-full"
                    [class.input-error]="skuFieldHasError($index, 'stockOnHand')"
                  />
                  @if (skuFieldHasError($index, 'stockOnHand')) {
                  <p class="text-error text-xs mt-0.5">{{ getSkuFieldError($index, 'stockOnHand') }}</p>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Step 4: Location (Products Only) -->
    @if (itemType() === 'product') {
    <div class="card bg-base-200">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-1">4Ô∏è‚É£ Location</h3>
        @if (defaultLocation()) {
        <p class="text-sm">üìç {{ defaultLocation()!.name }}</p>
        } @else {
        <p class="text-sm text-error">‚ö†Ô∏è No location available</p>
        }
      </div>
    </div>
    }

    <!-- Hidden barcode scanner -->
    <div class="hidden">
      <app-barcode-scanner #barcodeScanner (barcodeScanned)="onBarcodeScanned($event)" />
    </div>
  </form>

  <!-- Action Bar -->
  <div
    class="fixed left-0 right-0 bg-base-100 border-t-2 border-base-300 shadow-xl lg:bottom-0 lg:z-40"
    style="bottom: 4rem; z-index: 51"
  >
    <div class="container-app py-2">
      <!-- Validation Issues -->
      @if (!canSubmit() && validationIssues().length > 0) {
      <div class="text-xs text-error text-center mb-2">
        @for (issue of validationIssues(); track $index; let last = $last) {
          <span>{{ issue }}@if (!last) { ¬∑ }</span>
        }
      </div>
      }

      <div class="flex gap-2">
        <button type="button" (click)="cancel()" class="btn btn-ghost btn-sm" [disabled]="isSubmitting()">Cancel</button>
        <button
          type="button"
          class="btn btn-primary flex-1"
          [disabled]="!canSubmit() || isSubmitting()"
          (click)="submitForm()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          <span>Creating...</span>
          } @else {
          <span>‚úì Create {{ itemType() === 'product' ? 'Product' : 'Service' }}</span>
          }
        </button>
      </div>
    </div>
  </div>
</div>
