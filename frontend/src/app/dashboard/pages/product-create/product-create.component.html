<!-- Product Creation -->
<div class="min-h-screen bg-base-200 p-3 sm:p-4 pb-32 lg:pb-4">
  @if (isReady()) {
    <div class="max-w-lg mx-auto" [formGroup]="productForm">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-xl font-bold">
            @if (isEditMode()) { Edit Product } @else { New Item }
          </h1>
          <p class="text-xs opacity-60">
            @if (currentStage() === 1) { Basic info } @else { Pricing & stock }
          </p>
        </div>
        <button type="button" class="btn btn-ghost btn-sm btn-circle" (click)="cancel()">âœ•</button>
      </div>

      <!-- Progress indicator using daisyUI -->
      <div class="flex items-center gap-2 mb-5">
        <button
          type="button"
          class="btn btn-circle w-8 h-8 min-h-0 p-0 text-xs font-semibold"
          [class.btn-primary]="currentStage() === 1"
          [class.btn-success]="currentStage() === 2"
          [class.btn-outline]="currentStage() !== 1 && currentStage() !== 2"
          [class.btn-ghost]="currentStage() === 2"
          (click)="goToStage1()"
        >
          1
        </button>
        <div class="flex-1 h-0.5 bg-base-300 transition-colors" [class.bg-success]="currentStage() === 2"></div>
        <button
          type="button"
          class="btn btn-circle w-8 h-8 min-h-0 p-0 text-xs font-semibold"
          [class.btn-primary]="currentStage() === 2"
          [class.btn-outline]="currentStage() !== 2"
          (click)="goToStage2()"
        >
          2
        </button>
      </div>

      <!-- Stage 1: Item type, product basics & how it's sold -->
      @if (currentStage() === 1) {
        <div class="space-y-4">
          <!-- Item type (product vs service) -->
          <app-item-type-selector [itemType]="itemType()" (itemTypeChange)="setItemType($event)" />

          <!-- Product name -->
          <app-product-name-input [nameControl]="nameControl" />

          <!-- How it's sold (presets) for products only -->
          @if (itemType() === 'product') {
            <app-how-sold-selector
              [selected]="howSoldPreset()"
              (selectedChange)="onHowSoldSelected($event)"
            />

            <!-- Measurement unit (only for measured presets) -->
            <app-measurement-unit-selector
              [measurementUnit]="measurementUnit()"
              [visible]="productType() === 'measured'"
              (unitChange)="setMeasurementUnit($event)"
            />
          }

          <!-- Identification -->
          <app-identification-selector
            #identificationSelector
            [identificationMethod]="identificationMethod()"
            [barcodeControl]="barcodeControl"
            [photoCount]="photoCount()"
            [hasValidIdentification]="hasValidIdentification()"
            (methodChange)="chooseIdentificationMethod($event)"
            (barcodeScanned)="onBarcodeScanned($event)"
            (photosChanged)="onPhotosChanged($event)"
          />

          <!-- Validation feedback -->
          @if (submitError() && currentStage() === 1) {
            <div class="alert alert-warning py-2">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-xs">{{ submitError() }}</span>
            </div>
          }

          <!-- Continue to Stage 2 -->
          <button
            type="button"
            class="btn btn-primary btn-block"
            (click)="goToStage2()"
          >
            Continue
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m9 18 6-6-6-6"/>
            </svg>
          </button>
        </div>
      }

      <!-- Stage 2: Variants / SKUs, pricing & stock -->
      @if (currentStage() === 2) {
        <div class="space-y-3">
          @if (itemType() === 'product') {
            <!-- Variant dimensions for products -->
            <app-variant-dimension-editor
              [variantDimensions]="variantDimensions()"
              [productType]="productType()"
              (addDimension)="addVariantDimension()"
              (removeDimension)="removeVariantDimension($event)"
              (updateOptions)="updateDimensionOptions($event.id, $event.options)"
            />

            <!-- Generated SKUs with pricing & opening stock -->
            <app-sku-list-editor [skus]="skus" [canRegenerate]="true" (regenerate)="generateSkus()" />
          }

          <!-- Service-specific form -->
          @if (itemType() === 'service') {
            <app-service-sku-editor [skuFormGroup]="firstSkuFormGroup" />
          }

          <!-- Validation Issues -->
          <app-validation-issues-panel [issues]="validationIssues()" />

          <!-- Location (bottom, just before create button) -->
          <app-location-display [location]="defaultLocation()" />
        </div>
      }

      <!-- Submit Button (Stage 2 only) -->
      @if (currentStage() === 2) {
        <app-submit-bar
          [canSubmit]="canSubmit()"
          [isLoading]="isLoading()"
          [isEditMode]="isEditMode()"
          [itemType]="itemType()"
          [submitError]="submitError()"
          [submitSuccess]="submitSuccess()"
          (submit)="submitForm()"
        />
      }
    </div>
  } @else {
    <!-- Loading state while dashboard initializes -->
    <div class="flex justify-center items-center min-h-[50vh]">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }
</div>
