<!-- Mobile-First Item Creation (Products & Services) -->

<!-- Header with Type Toggle -->
<div class="sticky top-0 z-30 bg-base-100/95 backdrop-blur-sm border-b">
  <div class="container-app py-2">
    <div class="flex items-center justify-between gap-2">
      <h1 class="text-lg font-bold">{{ itemType() === 'product' ? 'üì¶' : '‚ú®' }} Add Item</h1>
      <button type="button" (click)="cancel()" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
    </div>
    
    <!-- Product/Service Toggle -->
    <div class="tabs tabs-box mt-2">
      <button 
        type="button"
        class="tab"
        [class.tab-active]="itemType() === 'product'"
        (click)="toggleItemType('product')"
      >
        üì¶ Product
      </button>
      <button 
        type="button"
        class="tab"
        [class.tab-active]="itemType() === 'service'"
        (click)="toggleItemType('service')"
      >
        ‚ú® Service
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-app py-3 pb-32 max-w-lg mx-auto">
  <!-- Alerts -->
  @if (submitSuccess()) {
  <div role="alert" class="alert alert-success mb-3">
    <span>‚úì Created!</span>
  </div>
  }
  
  @if (submitError()) {
  <div role="alert" class="alert alert-error mb-3">
    <span>{{ submitError() }}</span>
  </div>
  }

  <!-- Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="space-y-3">
    
    <!-- Step 1: Identification -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-2">
          {{ itemType() === 'product' ? '1Ô∏è‚É£ How to ID This Item?' : '1Ô∏è‚É£ How to ID This Service?' }}
        </h3>
        
        <div class="grid gap-2">
          <!-- Option A: Barcode -->
          <div 
            class="p-2 rounded border-2 cursor-pointer"
            [class.border-primary]="identificationMethod() === 'barcode'"
            [class.bg-primary/5]="identificationMethod() === 'barcode'"
            [class.border-base-300]="identificationMethod() !== 'barcode'"
            (click)="chooseIdentificationMethod('barcode')"
          >
            <div class="flex items-center gap-2">
              <div class="text-xl">üè∑Ô∏è</div>
              <div class="flex-1">
                <span class="font-semibold text-sm">Barcode</span>
              </div>
              @if (identificationMethod() === 'barcode') {
              <div class="text-primary">‚úì</div>
              }
            </div>
            
            @if (identificationMethod() === 'barcode') {
            <div class="flex gap-2 mt-2">
              <input
                type="text"
                formControlName="barcode"
                placeholder="Or type manually"
                class="input input-sm input-bordered flex-1 font-mono"
              />
              <button
                type="button"
                (click)="startBarcodeScanner(); $event.stopPropagation()"
                class="btn btn-sm btn-primary"
              >
                üì∑
              </button>
            </div>
            }
          </div>

          <!-- Option B: Photos -->
          <div 
            class="p-2 rounded border-2 cursor-pointer"
            [class.border-primary]="identificationMethod() === 'label-photos'"
            [class.bg-primary/5]="identificationMethod() === 'label-photos'"
            [class.border-base-300]="identificationMethod() !== 'label-photos'"
            (click)="chooseIdentificationMethod('label-photos')"
          >
            <div class="flex items-center gap-2 mb-2">
              <div class="text-xl">üì∏</div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-sm">
                    {{ itemType() === 'product' ? 'Tag Photos' : 'Card Photos' }}
                  </span>
                  @if (photoCount() > 0) {
                  <span class="badge badge-xs badge-primary">{{ photoCount() }}/5</span>
                  }
                </div>
              </div>
              @if (identificationMethod() === 'label-photos' && photoCount() >= 5) {
              <div class="text-primary">‚úì</div>
              }
            </div>

            @if (identificationMethod() === 'label-photos') {
            <!-- Inline help based on type -->
            @if (itemType() === 'product') {
            <div class="bg-warning/10 p-2 rounded text-xs mb-2">
              <strong>Photo the TAG, not the item!</strong>
              <p class="opacity-80 mt-1">Example: "TOMATO 10/=" written on cardboard</p>
            </div>
            } @else {
            <div class="bg-info/10 p-2 rounded text-xs mb-2">
              <strong>Photo the SERVICE CARD!</strong>
              <p class="opacity-80 mt-1">Example: "Haircut" card with ‚úÇÔ∏è icon on desk</p>
            </div>
            }

            <div>
              <app-photo-manager 
                #photoManager
                (photoCountChange)="onPhotosChanged($event)"
              />
              @if (photoCount() > 0 && photoCount() < 5) {
              <div class="text-xs text-warning mt-1">Need {{ 5 - photoCount() }} more</div>
              }
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Product Name -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-2">2Ô∏è‚É£ Product Name</h3>
        <input
          type="text"
          formControlName="name"
          [placeholder]="itemType() === 'product' ? 'e.g., Tomatoes' : 'e.g., Haircut'"
          class="input input-bordered w-full"
          [class.input-error]="productForm.get('name')?.invalid && productForm.get('name')?.touched"
        />
      </div>
    </div>

    <!-- Step 3: SKUs (Multiple) -->
    <div class="card bg-base-100 shadow">
      <div class="card-body p-3">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold text-sm">3Ô∏è‚É£ SKUs (Sizes/Tiers)</h3>
          <button
            type="button"
            (click)="addSku()"
            class="btn btn-xs btn-primary"
          >
            + Add SKU
          </button>
        </div>
        
        <p class="text-xs opacity-60 mb-3">
          {{ itemType() === 'product' ? 'e.g., 1kg, 2kg, 5kg' : 'e.g., Kids, Regular, Premium' }}
        </p>

        <!-- SKU List -->
        <div formArrayName="skus" class="space-y-3">
          @for (sku of skus.controls; track $index) {
          <div [formGroupName]="$index" class="p-3 bg-base-200 rounded">
            <div class="flex items-start justify-between gap-2 mb-2">
              <span class="text-xs font-semibold opacity-70">SKU #{{ $index + 1 }}</span>
              @if (skus.length > 1) {
              <button
                type="button"
                (click)="removeSku($index)"
                class="btn btn-xs btn-ghost btn-circle text-error"
              >
                ‚úï
              </button>
              }
            </div>

            <div class="space-y-2">
              <!-- SKU Name -->
              <input
                type="text"
                formControlName="name"
                placeholder="Name (e.g., 1kg or Kids)"
                class="input input-sm input-bordered w-full"
              />

              <!-- SKU Code -->
              <input
                type="text"
                formControlName="sku"
                placeholder="SKU code"
                class="input input-sm input-bordered w-full font-mono"
                maxlength="50"
              />

              <!-- Price & Stock -->
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <input
                    type="number"
                    formControlName="price"
                    placeholder="Price"
                    step="0.01"
                    class="input input-sm input-bordered w-full"
                  />
                </div>

                @if (itemType() === 'product') {
                <div>
                  <input
                    type="number"
                    formControlName="stockOnHand"
                    placeholder="Stock"
                    class="input input-sm input-bordered w-full"
                  />
                </div>
                }
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Step 4: Location (Products Only) -->
    @if (itemType() === 'product') {
    <div class="card bg-base-200">
      <div class="card-body p-3">
        <h3 class="font-bold text-sm mb-1">4Ô∏è‚É£ Location</h3>
        @if (activeLocation()) {
        <p class="text-sm">üìç {{ activeLocation()!.name }}</p>
        } @else {
        <p class="text-sm text-error">‚ö†Ô∏è No location selected</p>
        }
      </div>
    </div>
    }

    <!-- Hidden barcode scanner -->
    <div class="hidden">
      <app-barcode-scanner #barcodeScanner (barcodeScanned)="onBarcodeScanned($event)" />
    </div>
  </form>

  <!-- Action Bar -->
  <div
    class="fixed left-0 right-0 bg-base-100 border-t-2 border-base-300 shadow-xl lg:bottom-0 lg:z-40"
    style="bottom: 4rem; z-index: 51"
  >
    <div class="container-app py-2">
      <!-- Validation Issues -->
      @if (!canSubmit() && validationIssues().length > 0) {
      <div class="text-xs text-error text-center mb-2">
        <span *ngFor="let issue of validationIssues(); let last = last">
          {{ issue }}<span *ngIf="!last"> ¬∑ </span>
        </span>
      </div>
      }

      <div class="flex gap-2">
        <button type="button" (click)="cancel()" class="btn btn-ghost btn-sm">Cancel</button>
        <button
          type="submit"
          (click)="onSubmit()"
          class="btn btn-primary flex-1"
          [disabled]="!canSubmit()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          <span>Creating...</span>
          } @else {
          <span>‚úì Create {{ itemType() === 'product' ? 'Product' : 'Service' }}</span>
          }
        </button>
      </div>
    </div>
  </div>
</div>
