@if (modalMode()) {
<!-- Modal Wrapper -->
<dialog [id]="modalId" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg">Order Details</h3>
      <button class="btn btn-ghost btn-sm btn-circle" (click)="close()" aria-label="Close">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>
    <!-- Order Content -->
    <ng-container [ngTemplateOutlet]="orderContent"></ng-container>
    <div class="modal-action mt-6">
      <button class="btn btn-primary" (click)="close()">Close</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button (click)="close()">close</button>
  </form>
</dialog>
}

<div class="space-y-6" [class.print-mode]="isPrintMode()">
  <!-- Header (hidden in print mode and modal mode) -->
  @if (showHeader() && !modalMode()) {
  <div class="no-print">
    <div class="flex items-center justify-between mb-6">
      <div>
        <button (click)="goBack()" class="btn btn-ghost btn-sm mb-2">‚Üê Back to Orders</button>
        <h1 class="text-3xl font-bold">Order {{ order()?.code || '' }}</h1>
      </div>
      @if (showPrintControls()) {
      <div class="flex gap-2">
        @if (canPrint()) {
        <select
          class="select select-bordered"
          [value]="selectedTemplate()"
          (change)="selectedTemplate.set($any($event.target).value)"
        >
          @for (template of templates; track template.id) {
          <option [value]="template.id">{{ template.name }}</option>
          }
        </select>
        <button class="btn btn-primary" (click)="handlePrint()" [disabled]="!order()">
          üñ®Ô∏è Print
        </button>
        }
      </div>
      }
    </div>
  </div>
  }

  <!-- Error Alert -->
  @if (error()) {
  <div role="alert" class="alert alert-error shadow-lg" [class.no-print]="!modalMode()">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6 shrink-0"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span class="flex-1">{{ error() }}</span>
    <button (click)="clearError()" class="btn btn-sm">Dismiss</button>
  </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="flex flex-col items-center justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-sm text-base-content/60 mt-4">Loading order...</p>
      </div>
    </div>
  </div>
  }

  <!-- Order Details -->
  @if (order()) {
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <!-- Order Header -->
      <app-order-detail-header
        [orderCode]="order()!.code"
        [orderState]="order()!.state"
        [orderDate]="order()!.orderPlacedAt || order()!.createdAt"
      />

      <!-- Customer Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <app-order-customer-info [customer]="order()!.customer" />
        <app-order-address
          [address]="order()!.billingAddress"
          [label]="'Billing Address'"
          [fallbackName]="customerName()"
        />
      </div>

      <!-- Shipping Address -->
      @if (hasShipping() && order()!.shippingAddress) {
      <div class="mb-6 hidden-print">
        <app-order-address
          [address]="order()!.shippingAddress"
          [label]="'Shipping Address'"
          [fallbackName]="customerName()"
        />
      </div>
      }

      <!-- Order Items -->
      <app-order-items-table [lines]="order()!.lines" />

      <!-- Totals -->
      <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />

      <!-- Payment Information -->
      <app-order-payment-info [payments]="order()!.payments" />

      <!-- Fulfillment Information -->
      <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
    </div>
  </div>
  }
</div>

<!-- Order Content Template (for modal mode) -->
<ng-template #orderContent>
  <!-- Error Alert (for modal mode) -->
  @if (error()) {
  <div role="alert" class="alert alert-error mb-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6 shrink-0"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span class="flex-1">{{ error() }}</span>
    <button (click)="clearError()" class="btn btn-sm">Dismiss</button>
  </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="flex flex-col items-center justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-sm text-base-content/60 mt-4">Loading order...</p>
      </div>
    </div>
  </div>
  }

  <!-- Order Details -->
  @if (order()) {
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <!-- Order Header -->
      <app-order-detail-header
        [orderCode]="order()!.code"
        [orderState]="order()!.state"
        [orderDate]="order()!.orderPlacedAt || order()!.createdAt"
      />

      <!-- Customer Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <app-order-customer-info [customer]="order()!.customer" />
        <app-order-address
          [address]="order()!.billingAddress"
          [label]="'Billing Address'"
          [fallbackName]="customerName()"
        />
      </div>

      <!-- Shipping Address -->
      @if (hasShipping() && order()!.shippingAddress) {
      <div class="mb-6 hidden-print">
        <app-order-address
          [address]="order()!.shippingAddress"
          [label]="'Shipping Address'"
          [fallbackName]="customerName()"
        />
      </div>
      }

      <!-- Order Items -->
      <app-order-items-table [lines]="order()!.lines" />

      <!-- Totals -->
      <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />

      <!-- Payment Information -->
      <app-order-payment-info [payments]="order()!.payments" />

      <!-- Fulfillment Information -->
      <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
    </div>
  </div>
  }
</ng-template>
