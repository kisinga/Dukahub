<div class="container mx-auto p-4 md:p-6 max-w-5xl">
  <!-- Header with Channel Info -->
  <div class="mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Create Product</h1>
        <p class="text-base-content/70 mt-1">Add a new product with SKUs to your inventory</p>
      </div>

      <!-- Active Channel Badge -->
      <div class="badge badge-lg badge-primary">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
          />
        </svg>
        Channel: {{ channelName() }}
      </div>
    </div>

    <div class="divider"></div>
  </div>

  <!-- Success Message -->
  @if (submitSuccess()) {
  <div role="alert" class="alert alert-success mb-6">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span>Product created successfully! Redirecting...</span>
  </div>
  }

  <!-- Error Message -->
  @if (submitError()) {
  <div role="alert" class="alert alert-error mb-6">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span>{{ submitError() }}</span>
  </div>
  }

  <!-- Main Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
    <div class="grid gap-6">
      <!-- Product Information Card -->
      <div class="card card-border bg-base-100">
        <div class="card-body">
          <h2 class="card-title">Product Information</h2>

          <!-- Product Name -->
          <label class="floating-label">
            <input
              type="text"
              formControlName="name"
              placeholder="Product Name"
              class="input"
              [class.input-error]="hasError('name')"
            />
            <span>Product Name *</span>
          </label>
          @if (hasError('name')) {
          <p class="text-error text-sm mt-1">{{ getErrorMessage('name') }}</p>
          }

          <!-- Product Description -->
          <label class="floating-label mt-4">
            <textarea
              formControlName="description"
              placeholder="Product Description"
              class="textarea"
              rows="3"
              [class.textarea-error]="hasError('description')"
            ></textarea>
            <span>Product Description *</span>
          </label>
          @if (hasError('description')) {
          <p class="text-error text-sm mt-1">
            {{ getErrorMessage('description') }}
          </p>
          }
        </div>
      </div>

      <!-- Product Photos / Barcode Card -->
      <div class="card card-border bg-base-100">
        <div class="card-body">
          <!-- Tabs -->
          <div role="tablist" class="tabs tabs-boxed mb-4">
            <button
              type="button"
              role="tab"
              class="tab"
              [class.tab-active]="activeTab() === 'photos'"
              (click)="switchTab('photos')"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              Photos
            </button>
            <button
              type="button"
              role="tab"
              class="tab"
              [class.tab-active]="activeTab() === 'barcode'"
              (click)="switchTab('barcode')"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                />
              </svg>
              Barcode Scanner
            </button>
          </div>

          <!-- Photos Tab Content -->
          @if (activeTab() === 'photos') {
          <div>
            <h2 class="card-title">Product Photos (Optional)</h2>
            <p class="text-sm text-base-content/70 mb-4">
              Upload product images to help with visual identification
            </p>

            <!-- Photo Upload Button -->
            <div class="flex items-center gap-3 mb-4">
              <input
                type="file"
                #photoInput
                accept="image/*"
                multiple
                capture="environment"
                (change)="onPhotosSelected($event)"
                class="hidden"
              />

              <button type="button" (click)="photoInput.click()" class="btn btn-primary">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                Take Photo / Choose from Gallery
              </button>

              <div class="badge badge-lg" [class.badge-success]="photos().length > 0">
                {{ photos().length }} photo(s)
              </div>
            </div>

            <!-- Photo Previews Grid -->
            @if (photoPreviews().length > 0) {
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
              @for (preview of photoPreviews(); track $index; let i = $index) {
              <div class="relative group">
                <img
                  [src]="preview"
                  [alt]="'Product photo ' + (i + 1)"
                  class="w-full h-32 object-cover rounded-lg border-2 border-base-300"
                />
                <button
                  type="button"
                  (click)="removePhoto(i)"
                  class="btn btn-circle btn-sm btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
                @if (i === 0) {
                <div class="badge badge-primary badge-sm absolute bottom-1 left-1">Featured</div>
                }
              </div>
              }
            </div>
            } @else {
            <div role="alert" class="alert">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>No photos added yet. Photos are optional.</span>
            </div>
            }
          </div>
          }

          <!-- Barcode Tab Content -->
          @if (activeTab() === 'barcode') {
          <div>
            <h2 class="card-title">Scan Barcode for SKU</h2>
            <p class="text-sm text-base-content/70 mb-4">
              Scan product barcodes to automatically fill SKU fields
            </p>

            @if (!isScanningBarcode()) {
            <div role="alert" class="alert alert-info mb-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Click "Scan Barcode" button next to any SKU field below</span>
            </div>
            } @else {
            <div class="mb-4">
              <div class="relative aspect-video bg-black rounded-lg overflow-hidden">
                <video
                  #barcodeCamera
                  autoplay
                  playsinline
                  class="w-full h-full object-cover"
                ></video>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div class="border-2 border-primary w-3/4 h-3/4 rounded-lg"></div>
                </div>
              </div>
              <button
                type="button"
                (click)="stopBarcodeScanner()"
                class="btn btn-error btn-block mt-2"
              >
                Stop Scanner
              </button>
            </div>
            } @if (scannedBarcode()) {
            <div role="alert" class="alert alert-success">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Barcode scanned: {{ scannedBarcode() }}</span>
            </div>
            }
          </div>
          }
        </div>
      </div>

      <!-- Stock Location Card disabled for now-->
      <div class="card hidden card-border bg-base-100">
        <div class="card-body">
          <h2 class="card-title">Stock Location</h2>
          <p class="text-sm text-base-content/70 mb-4">
            Select where the initial stock will be stored
          </p>

          @if (isLoadingLocations()) {
          <div class="flex items-center gap-3">
            <span class="loading loading-spinner loading-md"></span>
            <span class="text-base-content/70">Loading stock locations...</span>
          </div>
          } @else if (locationsError()) {
          <div role="alert" class="alert alert-error">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>{{ locationsError() }}</span>
          </div>
          } @else if (stockLocations().length === 0) {
          <div role="alert" class="alert alert-warning">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <span>No stock locations found. Please create one in settings first.</span>
          </div>
          } @else {
          <select
            formControlName="stockLocationId"
            class="select"
            [class.select-error]="hasError('stockLocationId')"
          >
            <option value="" disabled>Select a stock location</option>
            @for (location of stockLocations(); track location.id) {
            <option [value]="location.id">
              {{ location.name }} @if (location.description) { - {{ location.description }} }
            </option>
            }
          </select>
          @if (hasError('stockLocationId')) {
          <p class="text-error text-sm mt-1">
            {{ getErrorMessage('stockLocationId') }}
          </p>
          } }
        </div>
      </div>
      <!-- Quick Setup Templates -->
      <div class="card card-border bg-base-100">
        <div class="card-body">
          <h2 class="card-title">Quick Setup</h2>
          <p class="text-sm text-base-content/70 mb-3">
            Choose a template to quickly set up common product variants
          </p>

          <!-- Template Chips (Multi-select) -->
          <div class="flex flex-wrap gap-2">
            @for (template of templates; track template.id) {
            <button
              type="button"
              (click)="toggleTemplate(template.id)"
              class="btn btn-sm"
              [class.btn-primary]="isTemplateSelected(template.id)"
              [class.btn-outline]="!isTemplateSelected(template.id)"
            >
              @if (isTemplateSelected(template.id)) {
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
              }
              {{ template.name }}
            </button>
            } @if (selectedTemplates().length > 0) {
            <button type="button" (click)="clearTemplates()" class="btn btn-sm btn-ghost">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
              Clear All
            </button>
            }

            <div class="divider divider-horizontal mx-2"></div>

            <!-- Add Custom Option Button - Always visible -->
            <button type="button" (click)="openCustomOptionModal()" class="btn btn-sm btn-outline">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                />
              </svg>
              Add Custom
            </button>
          </div>
          <p class="text-xs text-base-content/60 mt-2">
            ðŸ’¡ Select templates or add custom options (e.g., Bunch, Bundle, Case)
          </p>

          <!-- Show available options when templates are selected OR custom options exist -->
          @if (selectedTemplates().length > 0 || customOptions().length > 0) {
          <div class="mt-3 p-3 bg-base-200 rounded-lg">
            @if (selectedTemplates().length > 0) {
            <p class="text-sm font-medium mb-3">Available {{ selectedTemplateNames() }} options:</p>
            }

            <!-- Selectable pills (grouped by template) -->
            <div class="space-y-3">
              @for (templateId of selectedTemplates(); track templateId) {
              <div>
                <p class="text-xs font-medium text-base-content/70 mb-1">
                  {{ getTemplateName(templateId) }}:
                </p>
                <div class="flex flex-wrap gap-2">
                  @for (option of availableOptions(); track option.id) { @if
                  (optionBelongsToTemplate(option, templateId)) {
                  <button
                    type="button"
                    (click)="toggleOptionSelection(option.id)"
                    class="btn btn-sm"
                    [class.btn-primary]="isOptionSelected(option.id)"
                    [class.btn-outline]="!isOptionSelected(option.id)"
                  >
                    @if (isOptionSelected(option.id)) {
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                    }
                    {{ option.name }}
                  </button>
                  } }
                </div>
              </div>
              }

              <!-- Custom options -->
              @if (customOptions().length > 0) {
              <div>
                <p class="text-xs font-medium text-base-content/70 mb-1">Custom:</p>
                <div class="flex flex-wrap gap-2">
                  @for (option of availableOptions(); track option.id) { @if (option.isCustom) {
                  <button
                    type="button"
                    (click)="toggleOptionSelection(option.id)"
                    class="btn btn-sm"
                    [class.btn-primary]="isOptionSelected(option.id)"
                    [class.btn-outline]="!isOptionSelected(option.id)"
                  >
                    @if (isOptionSelected(option.id)) {
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                    }
                    {{ option.name }}
                    <span class="badge badge-xs">custom</span>
                  </button>
                  } }
                </div>
              </div>
              }
            </div>

            <p class="text-xs text-base-content/60 mt-2">
              ðŸ‘† Click to select options for your product SKUs
            </p>
          </div>
          }
        </div>
      </div>

      <!-- SKU Customization Cards -->
      <div formArrayName="variants" class="space-y-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">SKU Customization</h3>
          <button
            type="button"
            (click)="addCustomVariant()"
            class="btn btn-sm btn-outline btn-primary"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            Add Custom SKU
          </button>
        </div>

        <!-- Template-based SKUs -->
        @if (selectedOptionIds().length > 0) {
        <div class="space-y-6">
          @for (optionId of selectedOptionIds(); track optionId) {
          <div class="space-y-3">
            <!-- Option Header -->
            <div class="flex items-center justify-between">
              <div class="badge badge-primary badge-lg">
                {{ getOptionName(optionId) }}
              </div>
              <button
                type="button"
                (click)="addSkuForOption(optionId)"
                class="btn btn-xs btn-ghost"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                Add SKU
              </button>
            </div>

            <!-- SKU Cards for this option -->
            @for (variant of variants.controls; track $index; let i = $index) { @if
            (variant.get('optionId')?.value === optionId) {
            <div class="card card-border bg-base-100" [formGroupName]="i">
              <div class="card-body">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-sm font-medium">SKU #{{ i + 1 }}</span>
                  <button
                    type="button"
                    (click)="removeSkuVariant(i)"
                    class="btn btn-xs btn-circle btn-ghost"
                    title="Remove SKU"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Variant Name -->
                  <div class="md:col-span-2">
                    <label class="floating-label">
                      <input
                        type="text"
                        formControlName="name"
                        placeholder="e.g., One Kilogram, Two Kilograms"
                        class="input input-sm"
                        [class.input-error]="hasVariantError(i, 'name')"
                      />
                      <span>Variant Name *</span>
                    </label>
                    @if (hasVariantError(i, 'name')) {
                    <p class="text-error text-xs mt-1">
                      {{ getVariantErrorMessage(i, 'name') }}
                    </p>
                    }
                  </div>

                  <!-- SKU Code -->
                  <div>
                    <label class="floating-label">
                      <input
                        type="text"
                        formControlName="sku"
                        placeholder="e.g., KG1, KG2"
                        class="input input-sm"
                        [class.input-error]="hasVariantError(i, 'sku')"
                        maxlength="50"
                      />
                      <span>SKU *</span>
                    </label>
                    @if (hasVariantError(i, 'sku')) {
                    <p class="text-error text-xs mt-1">
                      {{ getVariantErrorMessage(i, 'sku') }}
                    </p>
                    }
                  </div>

                  <!-- Price -->
                  <div>
                    <label class="floating-label">
                      <input
                        type="number"
                        formControlName="price"
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                        class="input input-sm"
                        [class.input-error]="hasVariantError(i, 'price')"
                      />
                      <span>Price *</span>
                    </label>
                    @if (hasVariantError(i, 'price')) {
                    <p class="text-error text-xs mt-1">
                      {{ getVariantErrorMessage(i, 'price') }}
                    </p>
                    }
                  </div>

                  <!-- Stock Quantity -->
                  <div>
                    <label class="floating-label">
                      <input
                        type="number"
                        formControlName="stockOnHand"
                        placeholder="0"
                        min="0"
                        class="input input-sm"
                        [class.input-error]="hasVariantError(i, 'stockOnHand')"
                      />
                      <span>Initial Stock *</span>
                    </label>
                    @if (hasVariantError(i, 'stockOnHand')) {
                    <p class="text-error text-xs mt-1">
                      {{ getVariantErrorMessage(i, 'stockOnHand') }}
                    </p>
                    }
                  </div>
                </div>
              </div>
            </div>
            } }
          </div>
          }
        </div>
        }

        <!-- Custom SKUs (no template) -->
        @if (getCustomVariants().length > 0) {
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="badge badge-neutral badge-lg">Custom Variants</div>
          </div>

          @for (variant of variants.controls; track $index; let i = $index) { @if
          (!variant.get('optionId')?.value) {
          <div class="card card-border bg-base-100" [formGroupName]="i">
            <div class="card-body">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium">Custom SKU #{{ i + 1 }}</span>
                <button
                  type="button"
                  (click)="removeCustomVariant(i)"
                  class="btn btn-xs btn-circle btn-ghost"
                  title="Remove SKU"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Variant Name -->
                <div class="md:col-span-2">
                  <label class="floating-label">
                    <input
                      type="text"
                      formControlName="name"
                      placeholder="e.g., Standard Package, Bulk Deal"
                      class="input input-sm"
                      [class.input-error]="hasVariantError(i, 'name')"
                    />
                    <span>Variant Name *</span>
                  </label>
                  @if (hasVariantError(i, 'name')) {
                  <p class="text-error text-xs mt-1">
                    {{ getVariantErrorMessage(i, 'name') }}
                  </p>
                  }
                </div>

                <!-- SKU Code -->
                <div>
                  <label class="floating-label">
                    <input
                      type="text"
                      formControlName="sku"
                      placeholder="e.g., CUSTOM-001"
                      class="input input-sm"
                      [class.input-error]="hasVariantError(i, 'sku')"
                      maxlength="50"
                    />
                    <span>SKU *</span>
                  </label>
                  @if (hasVariantError(i, 'sku')) {
                  <p class="text-error text-xs mt-1">
                    {{ getVariantErrorMessage(i, 'sku') }}
                  </p>
                  }
                </div>

                <!-- Price -->
                <div>
                  <label class="floating-label">
                    <input
                      type="number"
                      formControlName="price"
                      placeholder="0.00"
                      step="0.01"
                      min="0"
                      class="input input-sm"
                      [class.input-error]="hasVariantError(i, 'price')"
                    />
                    <span>Price *</span>
                  </label>
                  @if (hasVariantError(i, 'price')) {
                  <p class="text-error text-xs mt-1">
                    {{ getVariantErrorMessage(i, 'price') }}
                  </p>
                  }
                </div>

                <!-- Stock Quantity -->
                <div>
                  <label class="floating-label">
                    <input
                      type="number"
                      formControlName="stockOnHand"
                      placeholder="0"
                      min="0"
                      class="input input-sm"
                      [class.input-error]="hasVariantError(i, 'stockOnHand')"
                    />
                    <span>Initial Stock *</span>
                  </label>
                  @if (hasVariantError(i, 'stockOnHand')) {
                  <p class="text-error text-xs mt-1">
                    {{ getVariantErrorMessage(i, 'stockOnHand') }}
                  </p>
                  }
                </div>
              </div>
            </div>
          </div>
          } }
        </div>
        }

        <!-- Empty state -->
        @if (selectedOptionIds().length === 0 && getCustomVariants().length === 0) {
        <div role="alert" class="alert">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <div>
            <p class="font-medium">No SKUs added yet</p>
            <p class="text-sm text-base-content/70">
              Select options from templates above or click "Add Custom SKU" to create variants
            </p>
          </div>
        </div>
        }
      </div>

      <!-- Form Actions -->
      <div class="flex flex-col-reverse sm:flex-row gap-3 justify-end">
        <button type="button" (click)="cancel()" class="btn btn-ghost">Cancel</button>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="!canSubmit()"
          [class.btn-disabled]="!canSubmit()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          Creating Product... } @else {
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Create Product }
        </button>
      </div>
    </div>
  </form>

  <!-- Custom Option Modal -->
  @if (showCustomOptionModal()) {
  <dialog open class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold mb-2">Add Custom Option</h3>
      <p class="text-sm text-base-content/70 mb-4">
        Create a new option type that's not in the templates (e.g., Bunch, Bundle, Case)
      </p>

      <form [formGroup]="customOptionForm" (ngSubmit)="addCustomOption()">
        <div class="space-y-4">
          <!-- Option Name -->
          <label class="floating-label">
            <input
              type="text"
              formControlName="name"
              placeholder="e.g., Bunch, Bundle, Case"
              class="input"
              [class.input-error]="
                customOptionForm.get('name')?.invalid && customOptionForm.get('name')?.touched
              "
            />
            <span>Option Name *</span>
          </label>
          <p class="text-xs text-base-content/60 -mt-2">
            This will appear as a selectable option alongside templates
          </p>

          <!-- SKU -->
          <label class="floating-label">
            <input
              type="text"
              formControlName="sku"
              placeholder="e.g., BUNCH, BND, CASE"
              class="input"
              maxlength="10"
              [class.input-error]="
                customOptionForm.get('sku')?.invalid && customOptionForm.get('sku')?.touched
              "
            />
            <span>SKU Code *</span>
          </label>
          <p class="text-xs text-base-content/60 -mt-2">
            Short code that will be used when creating SKUs
          </p>
        </div>

        <div class="modal-action">
          <button type="button" (click)="closeCustomOptionModal()" class="btn btn-ghost">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="customOptionForm.invalid">
            Add Option
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop" (click)="closeCustomOptionModal()">
      <button>close</button>
    </form>
  </dialog>
  }
</div>
