<div class="container mx-auto p-4 md:p-6 max-w-5xl">
  <!-- Header with Channel Info -->
  <div class="mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">
          {{ itemType() === 'product' ? 'Create Product' : 'Create Service' }}
        </h1>
        <p class="text-base-content/70 mt-1">
          {{
            itemType() === 'product'
              ? 'Add a new product with SKUs to your inventory'
              : 'Add a new service offering to your business'
          }}
        </p>
      </div>

      <!-- Active Channel Badge -->
      <div class="badge badge-lg badge-primary">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
          />
        </svg>
        Channel: {{ channelName() }}
      </div>
    </div>

    <!-- Item Type Tabs -->
    <div role="tablist" class="tabs tabs-boxed mt-4">
      <button
        type="button"
        role="tab"
        class="tab"
        [class.tab-active]="itemType() === 'product'"
        (click)="switchItemType('product')"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
          />
        </svg>
        Product
      </button>
      <button
        type="button"
        role="tab"
        class="tab"
        [class.tab-active]="itemType() === 'service'"
        (click)="switchItemType('service')"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
        Service
      </button>
    </div>

    <div class="divider"></div>
  </div>

  <!-- Success Message -->
  @if (submitSuccess()) {
  <div role="alert" class="alert alert-success mb-6">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span>Product created successfully! Redirecting...</span>
  </div>
  }

  <!-- Error Message -->
  @if (submitError()) {
  <div role="alert" class="alert alert-error mb-6">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span>{{ submitError() }}</span>
  </div>
  }

  <!-- Product Form -->
  @if (itemType() === 'product') {
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
    <div class="grid gap-6">
      <!-- Product Information (Extracted Component) -->
      <app-product-info-form [form]="productForm" />

      <!-- Product Photos (Extracted Component) -->
      <app-photo-manager #photoManager />

      <!-- Barcode Scanner (Extracted Component) -->
      <app-barcode-scanner #barcodeScanner />

      <!-- Stock Location Card disabled for now-->
      <div class="card hidden card-border bg-base-100">
        <div class="card-body">
          <h2 class="card-title">Stock Location</h2>
          <p class="text-sm text-base-content/70 mb-4">
            Select where the initial stock will be stored
          </p>

          @if (isLoadingLocations()) {
          <div class="flex items-center gap-3">
            <span class="loading loading-spinner loading-md"></span>
            <span class="text-base-content/70">Loading stock locations...</span>
          </div>
          } @else if (locationsError()) {
          <div role="alert" class="alert alert-error">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>{{ locationsError() }}</span>
          </div>
          } @else if (stockLocations().length === 0) {
          <div role="alert" class="alert alert-warning">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <span>No stock locations found. Please create one in settings first.</span>
          </div>
          } @else {
          <select formControlName="stockLocationId" class="select">
            <option value="" disabled>Select a stock location</option>
            @for (location of stockLocations(); track location.id) {
            <option [value]="location.id">
              {{ location.name }} @if (location.description) { - {{ location.description }} }
            </option>
            }
          </select>
          }
        </div>
      </div>
      <!-- Template Selector Component -->
      <app-template-selector
        [templates]="templates"
        [selectedTemplateIds]="selectedTemplates()"
        (templateToggled)="toggleTemplate($event)"
        (customOptionClicked)="openCustomOptionModal()"
        (clearAllClicked)="clearTemplates()"
      />

      <!-- Option Selector Component -->
      @if (selectedTemplates().length > 0 || customOptions().length > 0) {
      <app-option-selector
        [options]="availableOptions()"
        [selectedOptionIds]="selectedOptionIds()"
        [selectedTemplateIds]="selectedTemplates()"
        [templateNames]="selectedTemplateNames()"
        [templates]="templates"
        (optionToggled)="toggleOptionSelection($event)"
      />
      }

      <!-- SKU Customization Cards -->
      <div formArrayName="variants" class="space-y-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">SKU Customization</h3>
          <button
            type="button"
            (click)="addCustomVariant()"
            class="btn btn-sm btn-outline btn-primary"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            Add Custom SKU
          </button>
        </div>

        <!-- Generated Combination Variants -->
        @if (getComboVariants().length > 0) {
        <div class="space-y-3">
          <div class="flex items-center gap-2 mb-3">
            <h4 class="text-sm font-semibold">Auto-Generated Variants</h4>
            <span class="badge badge-sm badge-info">{{ getComboVariants().length }} variants</span>
          </div>

          @for (variant of variants.controls; track $index; let i = $index) { @if
          (variant.get('optionIds')?.value?.length > 0) {
          <div [formGroupName]="i">
            <app-variant-card
              [variantForm]="$any(variant)"
              [combinationLabel]="getVariantCombinationLabel(i)"
              [namePlaceholder]="'e.g., One Kilogram, Two Kilograms'"
              [skuPlaceholder]="'e.g., KG1, KG2'"
              (removed)="removeVariant(i)"
              (scanBarcodeClicked)="startBarcodeScanner(i)"
            />
          </div>
          } }
        </div>
        }

        <!-- Custom SKUs (manually added, no auto-generation) -->
        @if (getCustomVariants().length > 0) {
        <div class="space-y-3">
          <h4 class="text-sm font-semibold mb-3">Custom Variants</h4>

          @for (variant of variants.controls; track $index; let i = $index) { @if
          (variant.get('optionIds')?.value?.length === 0) {
          <div [formGroupName]="i">
            <app-variant-card
              [variantForm]="$any(variant)"
              [headerLabel]="'Custom SKU'"
              [namePlaceholder]="'e.g., Standard Package, Bulk Deal'"
              [skuPlaceholder]="'e.g., CUSTOM-001'"
              (removed)="removeVariant(i)"
              (scanBarcodeClicked)="startBarcodeScanner(i)"
            />
          </div>
          } }
        </div>
        }

        <!-- Empty state -->
        @if (variants.length === 0) {
        <div role="alert" class="alert">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <div>
            <p class="font-medium">No SKUs added yet</p>
            <p class="text-sm text-base-content/70">
              Select options from templates above to auto-generate variants, or click "Add Custom
              SKU"
            </p>
          </div>
        </div>
        }
      </div>

      <!-- Form Actions -->
      <div class="flex flex-col-reverse sm:flex-row gap-3 justify-end">
        <button type="button" (click)="cancel()" class="btn btn-ghost">Cancel</button>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="!canSubmit()"
          [class.btn-disabled]="!canSubmit()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          Creating Product... } @else {
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Create Product }
        </button>
      </div>
    </div>
  </form>

  <!-- Custom Option Modal Component -->
  <app-custom-option-modal
    [isOpen]="showCustomOptionModal()"
    [form]="customOptionForm"
    (submitted)="addCustomOption()"
    (cancelled)="closeCustomOptionModal()"
  />
  }

  <!-- Service Form (Extracted Component) -->
  @if (itemType() === 'service') {
  <form [formGroup]="serviceForm" (ngSubmit)="onSubmit()">
    <div class="grid gap-6">
      <app-service-form [form]="serviceForm" />

      <!-- Form Actions -->
      <div class="flex flex-col-reverse sm:flex-row gap-3 justify-end">
        <button type="button" (click)="cancel()" class="btn btn-ghost">Cancel</button>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="!canSubmit()"
          [class.btn-disabled]="!canSubmit()"
        >
          @if (isSubmitting()) {
          <span class="loading loading-spinner loading-sm"></span>
          Creating Service... } @else {
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Create Service }
        </button>
      </div>
    </div>
  </form>
  }
</div>
